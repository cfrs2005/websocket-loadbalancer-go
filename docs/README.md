# ğŸ“š WebSocketè´Ÿè½½å‡è¡¡ç³»ç»Ÿ - æ–‡æ¡£ä¸­å¿ƒ

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªçº¯Goå®ç°çš„WebSocketè´Ÿè½½å‡è¡¡ç³»ç»Ÿï¼Œæ”¯æŒå¤šå®¢æˆ·ç«¯è¿æ¥åˆ°å¤šä¸ªåç«¯æœåŠ¡å™¨ï¼Œå…·å¤‡æ•…éšœè½¬ç§»ã€å¥åº·æ£€æŸ¥å’ŒWebç®¡ç†ç•Œé¢ç­‰åŠŸèƒ½ã€‚

### ğŸ—ï¸ ç³»ç»Ÿæ¶æ„
```
å¤šä¸ªå®¢æˆ·ç«¯ â”€â”€â†’ è´Ÿè½½å‡è¡¡å™¨(8080) â”€â”€â†’ å¤šä¸ªæœåŠ¡ç«¯
    â†“                â†“                    â†“
  å®¢æˆ·ç«¯A         Webç®¡ç†ç•Œé¢          node1(8081)
  å®¢æˆ·ç«¯B         APIæ¥å£             node2(8082)  
  å®¢æˆ·ç«¯C         å¥åº·æ£€æŸ¥             node3(8083)
```

## ğŸ“– æ–‡æ¡£å¯¼èˆª

### ğŸš€ å¿«é€Ÿå¼€å§‹
- **[å¿«é€Ÿå‚è€ƒå¡ç‰‡](quick-reference.md)** - å¸¸ç”¨å‘½ä»¤å’Œæ“ä½œçš„å¿«é€Ÿå‚è€ƒ
- **[æœåŠ¡å™¨ç®¡ç†æŒ‡å—](server-management.md)** - è¯¦ç»†çš„æœåŠ¡å™¨ç®¡ç†æ–‡æ¡£
- **[APIæ¥å£æ–‡æ¡£](api-reference.md)** - å®Œæ•´çš„APIæ¥å£è¯´æ˜

### ğŸ“‹ æ–‡æ¡£åˆ—è¡¨

| æ–‡æ¡£åç§° | æè¿° | é€‚ç”¨å¯¹è±¡ |
|----------|------|----------|
| [quick-reference.md](quick-reference.md) | å¿«é€Ÿå‚è€ƒå¡ç‰‡ï¼ŒåŒ…å«å¸¸ç”¨å‘½ä»¤ | æ‰€æœ‰ç”¨æˆ· |
| [server-management.md](server-management.md) | è¯¦ç»†çš„æœåŠ¡å™¨ç®¡ç†æŒ‡å— | ç³»ç»Ÿç®¡ç†å‘˜ |
| [api-reference.md](api-reference.md) | APIæ¥å£æ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹ | å¼€å‘è€… |

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### 1. å¯åŠ¨å®Œæ•´ç³»ç»Ÿ
```bash
./start-loadbalancer.sh
```

### 2. å¯åŠ¨å®¢æˆ·ç«¯
```bash
./websocket-system -service=client -name=å®¢æˆ·ç«¯A &
./websocket-system -service=client -name=å®¢æˆ·ç«¯B &
```

### 3. è®¿é—®ç®¡ç†ç•Œé¢
```bash
open http://localhost:8080/web-loadbalancer.html
```

## ğŸ”§ ç³»ç»Ÿç»„ä»¶

### æ ¸å¿ƒæ–‡ä»¶
- `main.go` - ä¸»ç¨‹åºå…¥å£
- `loadbalancer.go` - è´Ÿè½½å‡è¡¡å™¨å®ç°
- `server.go` - åç«¯æœåŠ¡å™¨å®ç°
- `client.go` - å®¢æˆ·ç«¯å®ç°
- `protocol.go` - WebSocketæ¶ˆæ¯åè®®

### å¯åŠ¨è„šæœ¬
- `start-loadbalancer.sh` - å®Œæ•´ç³»ç»Ÿå¯åŠ¨è„šæœ¬
- `start-full.sh` - åŸæœ‰å¯åŠ¨è„šæœ¬(å·²åºŸå¼ƒ)

### Webç•Œé¢
- `web-loadbalancer.html` - è´Ÿè½½å‡è¡¡å™¨ç®¡ç†ç•Œé¢
- `web-client.html` - åŸæœ‰å®¢æˆ·ç«¯ç•Œé¢(å·²åºŸå¼ƒ)

## ğŸ“Š ç«¯å£é…ç½®

| æœåŠ¡ | ç«¯å£ | ç”¨é€” |
|------|------|------|
| è´Ÿè½½å‡è¡¡å™¨ | 8080 | å®¢æˆ·ç«¯è¿æ¥ + Webç®¡ç†ç•Œé¢ |
| åç«¯æœåŠ¡å™¨1 | 8081 | node1æœåŠ¡å™¨ |
| åç«¯æœåŠ¡å™¨2 | 8082 | node2æœåŠ¡å™¨ |
| åç«¯æœåŠ¡å™¨3 | 8083 | node3æœåŠ¡å™¨ |

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½éªŒè¯

### âœ… å·²å®ç°çš„éœ€æ±‚
1. **å¤šä¸ªå®¢æˆ·ç«¯å¯åŠ¨** - æ”¯æŒä»»æ„æ•°é‡å®¢æˆ·ç«¯è¿æ¥
2. **å¤šä¸ªæœåŠ¡ç«¯å¯åŠ¨** - æ”¯æŒ3ä¸ªåç«¯æœåŠ¡å™¨èŠ‚ç‚¹
3. **1ä¸ªè´Ÿè½½æœåŠ¡å™¨** - è´Ÿè½½å‡è¡¡å™¨ç»Ÿä¸€ç®¡ç†
4. **è´Ÿè½½æœåŠ¡å™¨è½¬å‘** - è½®è¯¢ç­–ç•¥åˆ†é…è¯·æ±‚
5. **å®¢æˆ·ç«¯è¿æ¥åˆ°è´Ÿè½½æœåŠ¡å™¨** - ç»Ÿä¸€æ¥å…¥ç‚¹
6. **Webç•Œé¢å±•ç¤ºå®¢æˆ·ç«¯åˆ—è¡¨** - å®æ—¶æ˜¾ç¤ºè¿æ¥çŠ¶æ€
7. **å®¢æˆ·ç«¯æœ‰ç‹¬ç«‹åå­—** - æ”¯æŒè‡ªå®šä¹‰å®¢æˆ·ç«¯åç§°
8. **æŸ¥è¯¢å®¢æˆ·ç«¯åå­—åŠŸèƒ½** - APIå’ŒWebç•Œé¢æ”¯æŒ
9. **æ•…éšœè½¬ç§»æœºåˆ¶** - æœåŠ¡ç«¯ä¸‹çº¿åè‡ªåŠ¨è½¬ç§»

### ğŸ”„ è´Ÿè½½å‡è¡¡ç‰¹æ€§
- **è½®è¯¢ç®—æ³•** - é»˜è®¤çš„è´Ÿè½½åˆ†é…ç­–ç•¥
- **å¥åº·æ£€æŸ¥** - 10ç§’é—´éš”æ£€æµ‹æœåŠ¡å™¨çŠ¶æ€
- **æ•…éšœè½¬ç§»** - è‡ªåŠ¨ç»•è¿‡ä¸å¥åº·çš„æœåŠ¡å™¨
- **è¿æ¥ç®¡ç†** - å®æ—¶è·Ÿè¸ªå®¢æˆ·ç«¯è¿æ¥çŠ¶æ€

## ğŸ§ª æµ‹è¯•éªŒè¯

### åŸºç¡€åŠŸèƒ½æµ‹è¯•
```bash
# 1. å¯åŠ¨ç³»ç»Ÿ
./start-loadbalancer.sh

# 2. å¯åŠ¨å®¢æˆ·ç«¯
./websocket-system -service=client -name=æµ‹è¯•å®¢æˆ·ç«¯A &

# 3. éªŒè¯è¿æ¥
curl -s http://localhost:8080/api/clients | python3 -m json.tool

# 4. æµ‹è¯•æŸ¥è¯¢
CLIENT_ID=$(curl -s http://localhost:8080/api/clients | python3 -c "import sys, json; data=json.load(sys.stdin); print(data['clients'][0]['id']) if data['clients'] else print('none')")
curl -s "http://localhost:8080/api/query?client_id=$CLIENT_ID" | python3 -m json.tool
```

### æ•…éšœè½¬ç§»æµ‹è¯•
```bash
# 1. å…³é—­node2æœåŠ¡å™¨
lsof -ti:8082 | xargs kill

# 2. ç­‰å¾…å¥åº·æ£€æŸ¥
sleep 12

# 3. æŸ¥çœ‹çŠ¶æ€å˜åŒ–
curl -s http://localhost:8080/api/backends | python3 -m json.tool

# 4. é‡å¯node2
./websocket-system -service=server -mode=single -port=8082 -node=node2 &
```

## ğŸ“ˆ ç›‘æ§å’Œç»´æŠ¤

### å®æ—¶ç›‘æ§
```bash
# ç›‘æ§å®¢æˆ·ç«¯æ•°é‡
watch -n 2 'curl -s http://localhost:8080/api/clients | jq ".total"'

# ç›‘æ§æœåŠ¡å™¨å¥åº·çŠ¶æ€
watch -n 5 'curl -s http://localhost:8080/api/backends | jq ".backends[] | {id: .id, healthy: .is_healthy}"'
```

### æ—¥å¿—æŸ¥çœ‹
```bash
# æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
journalctl -f | grep websocket

# æŸ¥çœ‹ç«¯å£ä½¿ç”¨æƒ…å†µ
lsof -i:8080,8081,8082,8083
```

## ğŸ†˜ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜
1. **ç«¯å£è¢«å ç”¨** - ä½¿ç”¨ `lsof -ti:PORT | xargs kill` æ¸…ç†
2. **å®¢æˆ·ç«¯è¿æ¥å¤±è´¥** - æ£€æŸ¥è´Ÿè½½å‡è¡¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ
3. **Webç•Œé¢æ— æ³•è®¿é—®** - ç¡®è®¤8080ç«¯å£å¯è®¿é—®
4. **å¥åº·æ£€æŸ¥å¤±è´¥** - æ£€æŸ¥åç«¯æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸å¯åŠ¨

### ç´§æ€¥æ¢å¤
```bash
# åœæ­¢æ‰€æœ‰æœåŠ¡
pkill -f websocket-system

# æ¸…ç†æ‰€æœ‰ç«¯å£
for port in 8080 8081 8082 8083; do
    lsof -ti:$port | xargs kill -9 2>/dev/null
done

# é‡æ–°å¯åŠ¨
./start-loadbalancer.sh
```

## ğŸ”— ç›¸å…³èµ„æº

### æŠ€æœ¯æ ˆ
- **Go 1.21+** - ä¸»è¦ç¼–ç¨‹è¯­è¨€
- **gorilla/websocket** - WebSocketåº“
- **çº¯HTML/CSS/JavaScript** - Webç®¡ç†ç•Œé¢

### æ‰©å±•åŠŸèƒ½
- æ”¯æŒæ›´å¤šè´Ÿè½½å‡è¡¡ç­–ç•¥(æœ€å°‘è¿æ¥ã€IPå“ˆå¸Œ)
- Dockerå®¹å™¨åŒ–éƒ¨ç½²
- Nginxåå‘ä»£ç†é›†æˆ
- æ›´å¤šç›‘æ§æŒ‡æ ‡

## ğŸ“ æ”¯æŒå’Œåé¦ˆ

### æ–‡æ¡£é—®é¢˜
å¦‚æœå‘ç°æ–‡æ¡£æœ‰è¯¯æˆ–éœ€è¦è¡¥å……ï¼Œè¯·ï¼š
1. æ£€æŸ¥æœ€æ–°ç‰ˆæœ¬çš„æ–‡æ¡£
2. æŸ¥çœ‹ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯
3. è”ç³»å¼€å‘å›¢é˜Ÿ

### æŠ€æœ¯æ”¯æŒ
- **ç³»ç»Ÿæ—¥å¿—**: æŸ¥çœ‹ç¨‹åºè¾“å‡ºå’Œé”™è¯¯ä¿¡æ¯
- **APIæµ‹è¯•**: ä½¿ç”¨curlå‘½ä»¤éªŒè¯æ¥å£åŠŸèƒ½
- **Webç•Œé¢**: é€šè¿‡ç®¡ç†ç•Œé¢æŸ¥çœ‹å®æ—¶çŠ¶æ€

---

**ğŸ“ æ–‡æ¡£ç»´æŠ¤**: WebSocketè´Ÿè½½å‡è¡¡ç³»ç»Ÿå¼€å‘å›¢é˜Ÿ  
**ğŸ”„ æœ€åæ›´æ–°**: 2025-09-08  
**ğŸ“§ ç‰ˆæœ¬**: v1.0

> ğŸ’¡ **æç¤º**: å»ºè®®å…ˆé˜…è¯» [quick-reference.md](quick-reference.md) äº†è§£åŸºæœ¬æ“ä½œï¼Œç„¶åæ ¹æ®éœ€è¦æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£ã€‚